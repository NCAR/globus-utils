#!/bin/bash
#
#   The main body of the gci command is split off into this
#   separate script because it is necessary to run these commands
#   within an SSH call if running in a Cheyenne batch node.
#
#   Author:         Brian Vanderwende
#   Last Revised:   09:32, 11 Mar 2022
#

# First, make sure environment is configured for globus
echo "Initializing Globus CLI environment ..."

if ! which globus &> /dev/null; then
    if [[ -n $NCAR_HOST ]]; then
        module purge &> /dev/null
        module load ncarenv conda &> /dev/null
        conda activate npl &> /dev/null
    else
        >&2 echo "Error: cannot find globus command in current PATH"
        exit 1
    fi
fi

# Then, make sure the user is logged in
if ! globus whoami &> /dev/null; then
    echo 'Error: login to Globus service using "globus login" before using gci'
    echo '       (access Globus CLI via NCAR Python Library conda environment)'
    exit 1
fi

# Set fields we care about in commands
BFILE=
CSPREFIX=/glade/campaign
CERTFILE=~/.$USER-globus.cert
EPQTAPE=$(globus endpoint search "NCAR Quasar"              \
          --filter-owner-id ncar@globusid.org               \
          --jq "DATA[0].id" --format UNIX)
EPGLADE=$(globus endpoint search "NCAR GLADE"               \
          --filter-owner-id ncar@globusid.org               \
          --jq "DATA[0].id" --format UNIX)
EPSTORE=$(globus endpoint search "NCAR Campaign Storage"    \
          --filter-owner-id ncar@globusid.org               \
          --jq "DATA[0].id" --format UNIX)

# User messages
function cert_notice {
cat << EOF
Note:  CISL endpoints are not activated and no long-lived certificate is
       available. Consider certificate activation if using commands in
       unattended workflow.

Using standard authenication with two-factor login ..."
EOF
}

# Next, perform endpoint activation check
echo "Checking endpoint status ..."
MSGDONE=false

for EPID in $EPQTAPE $EPGLADE $EPSTORE; do
    if ! globus endpoint is-activated $EPID &> /dev/null || [[ $AFORCE == true ]]; then
        if [[ $LIFETIME != 12 ]] && [[ $MSGDONE == false ]]; then
            echo "Using custom lifetime of $LIFETIME h"
            MSGDONE=true
        fi

        echo "  activating $EPID"

        if [[ -f $CERTFILE ]]; then
            globus endpoint activate    --no-autoactivate --force   \
                                        --delegate-proxy $CERTFILE  \
                                        --proxy-lifetime $LIFETIME  \
                                        $EPID > /dev/null
        else
            cert_notice
            globus endpoint activate    --no-autoactivate --force   \
                                        --proxy-lifetime $LIFETIME  \
                                        --myproxy $EPID
        fi

        STATUS=$?

        if [[ $STATUS != 0 ]]; then
            echo "Error: could not activate endpoint (error $STATUS). Aborting."
            exit 2
        fi
    fi
done

# Now that we are configured, run sub-command
export GCICMD=$1

# Scan Globus options for impactful settings
for KEY in $@; do
    case $KEY in
        --batch)
            export BMODE=true
            export BFILE=$(mktemp ${TMPDIR:-/tmp/}/.gcibatch.XXXXXX)
            ;;
        -r|--recursive)
            export RMODE=true
            ;;
    esac
done

if [[ -f $GCIBIN/$GCICMD ]]; then
    shift
    export EPQTAPE EPGLADE EPSTORE CSPREFIX
    echo
    $GCIBIN/$GCICMD $@
    RETCODE=$?
else
    echo -e "Error: invalid command $GCICMD\n"
    usage
    RETCODE=1
fi

rm -f $BFILE
exit $RETCODE
