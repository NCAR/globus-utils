#!/bin/bash

TID=$1

if [[ $BGCMD != true ]]; then
    echo -n "Waiting for completion of task (ID $TID) ... "

    while true; do
        globus task wait --timeout 30 $TID &> /dev/null

        if [[ $? == 0 ]]; then
            echo "succeeded"
            break
        else
            STAT=$(globus task show --format UNIX --jq "nice_status" $TID 2> /dev/null)

            case $STAT in
                PERMISSION_DENIED)
                    echo "failed (permission denied)"
                    ENDTERM=10
                    ;;
            esac
        fi

        if [[ ${ENDTERM}z != z ]]; then
            globus task cancel $TID &> /dev/null
            exit $ENDTERM
        fi
    done
fi
