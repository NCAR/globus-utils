#!/bin/bash

TID=$1 ENDTERM=1

function clean_up {
    echo -e -n "\nCancelling task (ID $TID) ... "
    globus task cancel $TID &> /dev/null
    echo "done"
    exit $ENDTERM
}

# Exit upon signal (so we don't resubmit SSH command)
trap clean_up SIGHUP SIGINT SIGQUIT SIGTERM

if [[ $BGCMD != true ]]; then
    echo -n "Waiting for completion of task (ID $TID) ... "

    while true; do
        globus task wait --timeout 30 $TID &> /dev/null

        if [[ $? == 0 ]]; then
            echo "succeeded"
            break
        else
            STAT=$(globus task show --format UNIX --jq "nice_status" $TID 2> /dev/null)

            case $STAT in
                PERMISSION_DENIED)
                    echo "failed (permission denied)"
                    ENDTERM=10
                    ;;
                FILE_NOT_FOUND)
                    echo "failed (file not found)"
                    ENDTERM=11
                    ;;
                IS_A_DIRECTORY)
                    echo "failed (directory without recursive option)"
                    ENDTERM=12
                    ;;
                AUTH)
                    echo "failed (authentication error)"
                    echo -e "\nContact CISLHelp for debug support"
                    ENDTERM=13
                    ;;
            esac
        fi

        if [[ $ENDTERM != 1 ]]; then
            clean_up
        fi
    done
fi
